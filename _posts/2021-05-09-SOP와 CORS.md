---
title: "SOP와 CORS 2021-05-09"
date: 2021-05-09 00:01:28 -0400
categories: Development
---

XSS나 CSRF 등의 보안 취약점을 노린 공격을 방어하기 위한 정책인 SOP와 그를 허용하기 위한 CORS에 대해 알아봅니다.
<hr/>

## [ SOP(Same-Origin-Policy) ]
SOP란 같은 출처의 리소스만 공유할 수 있다는 정책입니다. 하지만 다른 출처의 리소스를 사용하는 일은 굉장히 흔한 일이라 몇가지 예외 사항을 두고 있는데, 그 중 하나가 CORS 정책을 지킨 리소스 요청입니다.
<br>
즉, 브라우저가 SOP를 지키기 때문에 CORS 정책을 지켜 개발을 해야 하는 것입니다. 그렇다면 어차피 정해진 서버로만 통신을 할 텐데 왜 이런 정책이 필요한지 알아보겠습니다.

## [ SOP의 과정과 해결 방법 ]
SOP는 서버가 아닌 브라우저에 구현되어 있는 로직입니다. SOP 정책을 위반하더라도 API 테스트 과정에서는 서버가 정상적으로 응답을 하게 되지만, 브라우저를 통해 요청할 때는 서버가 정상적으로 응답하더라도 브라우저가 그 응답을 버리게 됩니다. 
<br>
이를 통해 브라우저는 XSS나 CSRF 등의 공격 방식을 방어할 수 있습니다. 하지만 다른 출처의 리소스를 사용하는 것은 아주 흔한 일이기 때문에 CORS 정책을 지킨 리소스 요청을 허용하는 예외를 두고 있습니다.

## [ CORS(Cross-Origin-Resource-Sharing) ]
CORS는 브라우저에서 다른 출처의 리소스를 공유하는 방법입니다. 
<br>
먼저 출처를 알기 위해서는 URL 구조에 대해 알고 있어야 합니다.

```
https://jjmin321.github.io:443/development/CORS/

https - Protocol 
jjmin321 - Host
github.io - Domain
:443 - Port (생략됨)
/development/CORS - Path
```
<br>
위에서 나온 Protocol, Host, Domain, Port를 합친, 즉 https://jjmin321.github.io를 출처라고 합니다. 

## [ CORS 동작 원리 ]
기본적으로 웹 애플리케이션이 리소스를 요청할 때는 HTTP 프로토콜을 통해 요청을 보내게 되는데, 이 때 브라우저는 요청 헤더의 Origin이라는 필드에 출처를 함께 담아보냅니다.
<br>
이후 서버는 응답을 할 때, Access-Control-Allow-Origin이라는 값에 요청이 허용된 출처를 보내주고 브라우저는 요청한 출처가 허용된 출처인지를 확인합니다.

```java
response.setHeader("Access-Control-Allow-Origin", "jjmin321.github.io");
```
기본적으로는 간단하지만, CORS의 동작 방식은 한 가지가 아닌 세 가지의 시나리오에 따라 변경되기 때문에 어떤 시나리오에 위반되었는지 알기 위해 모든 시나리오에 대해 알고 있어야 합니다.

## [ Preflight Request ]
Preflight 방식은 일반적으로 우리가 웹 애플레케이션을 개발할 때 가장 많이 마주치는 시나리오이다. 이 시나리오에 해당하는 상황일 때 브라우저는 요청을 한 번에 보내지 않고 예비 요청과 본 요청으로 나누어서 서버를 전송한다.
<br>
브라우저가 본 요청을 보내기 전에 보내는 예비 요청을 Preflight라고 하며, 이 예비 요청에는 HTTP 메소드 중 OPTIONS 메소드가 사용된다. 예비 요청의 역할은 본 요청을 보내기 전에 브라우저 스스로 이 요청을 보내는 것이 안전한지 확인하는 것이다. 
<br>
이 과정을 플로우 차트로 나타내면 이런 느낌이다.

![cors-preflight](https://user-images.githubusercontent.com/52072077/117592110-4d86cc80-b172-11eb-947f-30157c8a4a25.png)

자바스크립트를 사용해 브라우저에게 리소스를 받아오라는 명령을 내리면 브라우저는 서버에게 OPTIONS 메소드를 통해 예비 요청을 먼저 보내고, 서버는 이 예비 요청에 대한 응답으로 어떤 것들을 허용하고, 어떤 것들을 금지하고 있는지에 대한 정보를 응답 헤더에 담아서 브라우저에게 보내준다.
<br>
이후 브라우저는 서버의 허용 정책을 비교한 후, 안전하다고 판단하면 본 요청을 실제 메소드로 보내게 되고 본 요청에 대한 응답을 실제 자바스크립트에게 넘겨준다.

## [ Simple Request ]

## [ 출처를 비교하는 과정 ]


