---
title: "도커를 사용하여 5분만에 배포 끝내는 법 2020-11-20"
date: 2020-12-06 00:01:28 -0400
categories: Development
---
도커에 대해 가볍게 정리해보았습니다
<hr>

# 도커를 사용하게 된 계기 
저는 항상 서버 배포를 할 때 리눅스 커널에 들어가 모든 개발 환경을 세팅한 다음, git clone을 받고 명령어를 직접 모두 친 뒤에야 성공적으로 배포를 할 수 있었습니다.
이 과정은 어렵지는 않지만 계속 하다보면 싫증이 나고 은근 시간도 정말 많이 잡아먹게 됩니다.

![1280px-Docker_(container_engine)_logo svg](https://user-images.githubusercontent.com/52072077/101272368-f0f04180-37ce-11eb-876b-704250fa9cc2.png)


제가 도커를 사용하게 된 계기는 바로 이것입니다. 

도커는 애플리케이션을 신속하게 구축, 테스트 및 배포할 수 있는 소프트웨어 플랫폼입니다.
OS에 구애받지 않을 수 있어 테스트를 마친 후 리눅스에서 실행만 하면 끝이죠.

## 백문이 불여일견이므로 어떻게 사용하였는지 알아보겠습니다.
1. 프로젝트 상위폴더에 Dockerfile을 만든 후 문법에 맞게 작성합니다. 
```docker
# dockerfile

FROM golang:1.14.2

LABEL Author="jjmin321@naver.com"

COPY . src

WORKDIR /go/src

CMD [ "go", "run", "main.go"]

EXPOSE 8080
```
2. Dockerfile을 작성했으면 make build 명령어로 randomchatting_server라는 이미지를 생성합니다.
```makefile
# makefile
# 이 글에서 사용할 도커 명령어는 총 4가지이므로 makefile을 통해 사용하겠습니다.

build:
	@docker build --tag randomchatting_server .

run:
	@docker run -i -t -p 8080:8080/tcp --name server randomchatting_server
```

3. make run을 하면 randomchatting_server 이미지를 server라는 이름의 컨테이너로 생성합니다.

4. 위 3가지를 순서대로 하고 나면, 서버 배포가 끝납니다.

## Dockerfile 뜯어보기 
1. FROM golang:1.14.2
    - go 1.14.2 버전을 사용
2. LABEL Author='jjmin321@naver.com'
    - jjmin321@naver.com이 작성
3. COPY . src
    - 프로젝트 전체파일을 컨테이너 내 go/src 폴더에 추가
4. WORKDIR /go/src
    - 컨테이너 내에서 /go/src로 이동
5. CMD [ "go", "run", "main.go"]
    - go run main.go로 서버를 실행 
6. EXPOSE 8080
    - OS의 8080포트와 이 컨테이너를 연결

## 하지만 데이터베이스나 OpenCV같은 기술과 서버가 연동되어 있다면?

Dockerfile에서 데이터베이스를 설치하고 환경 설정까지 커맨드를 작성하여 모두 해 줄 수 있습니다.
그러나 이는 각각의 컨테이너로 동작할 수 있는 도커의 장점을 사용하지 않는 것 같아서 docker-compose를 사용하여 데이터베이스 컨테이너를 따로 분리하기로 했습니다.

1. 프로젝트 상위폴더에 docker-compose.yml 파일 생성 후 문법에 맞게 작성 
```yml
# docker-compose.yml
# 환경변수를 사용할 수 있다.
version: '3'
services: 
  postgres:
    image: postgres:12
    container_name: postgres
    environment: 
      - POSTGRES_DB=${DB}
      - POSTGRES_USER=${DBUSER}
      - POSTGRES_PASSWORD=${PASSWORD}
    ports:
      - '${IP}:${POSTGRESQL}'
```

2. make compose-up 명령어를 실행하면 postgres 컨테이너가 독립적으로 실행된다.
```makefile
# makefile
# 이 글에서 사용할 도커 명령어는 총 4가지이므로 makefile을 통해 사용하겠습니다.

compose-up:
	@docker-compose --env-file docker.env -f docker-compose.yml up

compose-down:
	@docker-compose --env-file docker.env -f docker-compose.yml down
```

3. docker-compose.yml에 작성한 ports를 기반으로 외부에서 접근이 가능하게끔 만들었지만, 이렇게 하지 않고 link를 시켜주는 방법도 있다.

4. 이런 방식으로 웹, 서버, 데이터베이스를 모두 도커를 통해 배포하면 5분도 채 걸리지 않는다.

![linux](https://user-images.githubusercontent.com/52072077/101272866-97d6dc80-37d3-11eb-9fa4-ed592f4c96ab.png)

